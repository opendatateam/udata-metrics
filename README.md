# udata-metrics

This plugin handles the connexion to an InfluxDB service for udata.
It provides a client to store and to retrieve views and hits generated by users before injecting them in udata's objects metrics.
It should be used in conjunction with [our log pipeline with vector](https://github.com/etalab/vector-test).

Its process is in three steps that should be scheduled to run daily (based on the previous day metrics):
- Aggregation of InfluxDB data of the previous day to count the number of resource, dataset, organisation and reuse views.
- Deletion of unaggregated metrics of the previous day in InfluxDB.
- Aggregation of daily metrics into all-time metrics and storage of these in udata MongoDB.

## Installation

Install [udata](https://github.com/opendatateam/udata).  

Remain in the same virtual environment (for Python).

Install **udata-metrics**:

```shell
pip install udata-metrics
```

Modify your local configuration file of **udata** (typically, `udata.cfg`) as following:

```python
PLUGINS = ['metrics']
METRICS_INFLUX_DSN = {
    "url": "http://localhost:8086/",
    "org": "etalab",
    "token": "...",
}
METRICS_VECTOR_BUCKET = "vector-bucket"
```

## Usage

Schedule the `aggregate-metrics-last-day` job with the following command:
```
udata job schedule aggregate-metrics-last-day "30 5 * * *"
```
See [the docs](https://udata.readthedocs.io/en/latest/administrative-tasks/) for more about scheduling tasks.
